<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MicFinder - Command Center</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&family=Space+Grotesk:wght@500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            overflow: hidden;
        }
        .font-mono { font-family: 'Space Mono', monospace; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }

        /* Lens card from F.html */
        .lens-card {
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .lens-card:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.06);
        }

        /* Badge pulse */
        .badge-pulse { animation: badge-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes badge-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }

        /* Action icon hover */
        .action-icon { transition: all 0.2s ease; }
        .action-icon:hover { color: #fbbf24; transform: scale(1.1); }

        /* --- THE GLASS EFFECT --- */
        .glass-panel {
            background: rgba(18, 18, 21, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.8);
        }

        /* --- MAP DARK MODE FILTER --- */
        .leaflet-layer { 
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); 
        }
        .leaflet-container { background: #09090b; }

        /* --- UI TRANSITIONS --- */
        .capsule-btn { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .capsule-btn.active { 
            background: #fbbf24; 
            color: black; 
            font-weight: 700;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); 
        }
        .capsule-btn:not(.active) { color: #71717a; } 
        .capsule-btn:not(.active):hover { color: white; background: rgba(255,255,255,0.08); }

        /* Drawer Transition */
        #list-drawer { transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        #date-carousel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* --- SCROLLBAR HIDING --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- ANIMATIONS --- */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .pin-pulse::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            transform: translate(-50%, -50%);
            background: #fbbf24;
            border-radius: 50%;
            z-index: -1;
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes flash {
            0% { background: rgba(251, 191, 36, 0.2); }
            100% { background: transparent; }
        }
        .flash-card { animation: flash 1s ease-out; }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- 1. MAP LAYER -->
    <div id="map" class="absolute inset-0 z-0 bg-[#09090b]"></div>

    <!-- 2. COMMAND BAR (Top on Mobile / Top-Left on Desktop) -->
    <div class="absolute top-4 left-3 right-3 md:left-4 md:w-[380px] z-[1000] flex flex-col pointer-events-none">
        
        <!-- COMMAND CAPSULE -->
        <div class="glass-panel h-[56px] rounded-full flex items-center p-1.5 pointer-events-auto relative z-20">
            
            <!-- SEARCH INPUT -->
            <div class="flex-1 flex items-center h-full pl-4 pr-2 group cursor-text" onclick="document.getElementById('search-input').focus()">
                <svg class="w-4 h-4 text-neutral-500 group-focus-within:text-[#fbbf24] transition-colors shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="search-input" placeholder="Find a spot..." class="w-full bg-transparent border-none text-sm text-white placeholder-neutral-600 ml-2 font-medium h-full focus:outline-none focus:ring-0">
            </div>

            <!-- TIME SEGMENTED CONTROL -->
            <div class="flex items-center bg-black/40 rounded-full p-1 border border-white/5 shrink-0">
                <button onclick="setMode('today')" id="btn-today" class="capsule-btn active px-3 py-1.5 rounded-full text-[10px] uppercase tracking-wider leading-none">Today</button>
                <button onclick="setMode('tomorrow')" id="btn-tomorrow" class="capsule-btn px-3 py-1.5 rounded-full text-[10px] uppercase tracking-wider leading-none">Tmrw</button>
                <button onclick="setMode('calendar')" id="btn-calendar" class="capsule-btn w-7 h-7 flex items-center justify-center rounded-full">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </button>
            </div>

            <!-- DIVIDER -->
            <div class="w-[1px] h-5 bg-white/10 mx-2"></div>

            <!-- DRAWER TOGGLE -->
            <button onclick="toggleDrawer()" id="drawer-btn" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-neutral-400 hover:text-white transition-all active:scale-90">
                <svg id="chevron-icon" class="w-5 h-5 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- 3. LIST DRAWER (Separated Component) -->
    <!-- MOBILE: Fixed to Bottom | DESKTOP: Absolute Top-Left (under Command Bar) -->
    <div id="list-drawer" class="glass-panel rounded-3xl overflow-hidden flex flex-col pointer-events-auto 
        fixed bottom-4 left-3 right-3 z-[900] max-h-0 opacity-0
        md:absolute md:top-[76px] md:left-4 md:right-auto md:w-[380px] md:bottom-auto md:z-[1000]">
        
        <!-- STATUS HEADER -->
        <div class="px-5 py-3 border-b border-white/5 flex justify-between items-center bg-black/20 backdrop-blur-md shrink-0">
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-[#fbbf24] animate-pulse"></div>
                <span class="text-[10px] font-bold text-neutral-400 uppercase tracking-[0.2em]" id="results-count">Loading...</span>
            </div>
            <!-- Legend -->
            <div class="flex gap-3 opacity-50">
                 <span class="text-[9px] font-bold uppercase text-neutral-500 flex items-center gap-1">
                    <div class="w-1.5 h-1.5 bg-[#fbbf24] rounded-full"></div> Urgent
                 </span>
            </div>
        </div>

        <!-- CONTENT LIST -->
        <div id="list-content" class="overflow-y-auto no-scrollbar max-h-[50vh] md:max-h-[85vh] p-2 space-y-1 scroll-smooth">
            <!-- Cards injected via JS -->
        </div>
    </div>

    <!-- 4. DATE CAROUSEL (Bottom Layer - Mutually exclusive with List Drawer on mobile) -->
    <div id="date-carousel" class="fixed bottom-0 left-0 right-0 z-[1100] p-4 pointer-events-none transform translate-y-full">
        <div class="glass-panel mx-auto rounded-xl py-3 px-3 w-full md:max-w-xl pointer-events-auto">
            <div id="cal-grid" class="flex justify-start overflow-x-auto gap-2 no-scrollbar">
                <!-- Date Capsules Injected Here -->
            </div>
        </div>
    </div>

    <script>
        // --------------------------------------------------------
        // 1. DATA GENERATION & INITIAL STATE
        // --------------------------------------------------------
        const venues = ["Village Underground", "Comedy Cellar", "The Stand", "Grisly Pear", "Tiny Cupboard", "QED Astoria", "Grove 34", "Eastville", "West Side Comedy", "Gotham Club"];
        const hoods = ["West Village", "Greenwich", "Gramercy", "Bushwick", "Astoria", "Midtown", "Chelsea", "LES"];
        const mics = [];
        const now = new Date();

        function addDays(date, days) { const r = new Date(date); r.setDate(r.getDate() + days); return r; }

        for (let i = 0; i < 7; i++) {
            const dayBase = addDays(now, i);
            const numMics = 5 + Math.floor(Math.random() * 5); 
            
            for(let j=0; j<numMics; j++) {
                const hour = 17 + Math.floor(Math.random() * 9); 
                const micDate = new Date(dayBase);
                micDate.setHours(hour, (Math.random() > 0.5 ? 0 : 30), 0, 0);

                if (micDate < now) { micDate.setDate(micDate.getDate() + 7); }

                const diffMins = (micDate - now) / 60000;
                const isUrgent = diffMins > -15 && diffMins <= 90 && i === 0;

                mics.push({
                    id: `${i}-${j}`,
                    title: venues[Math.floor(Math.random() * venues.length)],
                    start: micDate,
                    timeStr: micDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}), 
                    lat: 40.73 + (Math.random() * 0.08 - 0.04),
                    lng: -73.99 + (Math.random() * 0.08 - 0.04),
                    price: Math.random() > 0.6 ? "$5" : "Free",
                    hood: hoods[Math.floor(Math.random() * hoods.length)],
                    isUrgent: isUrgent,
                    type: Math.random() > 0.5 ? "Bucket" : "Lottery"
                });
            }
        }
        mics.sort((a,b) => a.start - b.start);

        // --------------------------------------------------------
        // 2. MAP SETUP
        // --------------------------------------------------------
        const map = L.map('map', { zoomControl: false }).setView([40.735, -73.99], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
        const markersGroup = L.layerGroup().addTo(map);

        // --------------------------------------------------------
        // 3. UI STATE & RENDERING
        // --------------------------------------------------------
        let currentMode = 'today';
        let isDrawerOpen = false;
        let selectedCalendarDate = now.toDateString(); 

        function render(mode) {
            const container = document.getElementById('list-content');
            const countLabel = document.getElementById('results-count');
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            
            markersGroup.clearLayers();
            container.innerHTML = '';

            let filtered = mics.filter(m => {
                const micDateStr = m.start.toDateString();
                const todayStr = now.toDateString();
                const tmrwStr = addDays(now, 1).toDateString();
                
                if (mode === 'today' && micDateStr !== todayStr) return false;
                if (mode === 'tomorrow' && micDateStr !== tmrwStr) return false;
                if (mode === 'calendar' && micDateStr !== selectedCalendarDate) return false;
                if (searchVal && !m.title.toLowerCase().includes(searchVal) && !m.hood.toLowerCase().includes(searchVal)) return false;
                return true;
            });

            countLabel.innerText = `${filtered.length} SPOTS FOUND`;
            document.getElementById('status-dot').className = `w-2 h-2 rounded-full ${filtered.length > 0 ? 'bg-[#fbbf24] animate-pulse' : 'bg-red-500'}`;

            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-neutral-600 text-xs font-mono">NO MICS FOUND</div>`;
                return;
            }

            filtered.forEach(mic => {
                const color = mic.isUrgent && mic.start.toDateString() === now.toDateString() ? '#fbbf24' : '#52525b';
                const zIndex = mic.isUrgent ? 1000 : 100;
                const size = mic.isUrgent ? 16 : 12;
                
                const pinHtml = `<div id="pin-${mic.id}" class="relative w-full h-full flex items-center justify-center ${mic.isUrgent ? 'pin-pulse' : ''}">
                        <div style="width:${size}px; height:${size}px; background:${color}; border:2px solid white; border-radius:50%; box-shadow: 0 4px 6px rgba(0,0,0,0.5);"></div>
                    </div>`;
                
                const icon = L.divIcon({ className: 'bg-transparent', html: pinHtml, iconSize: [30, 30] });
                const marker = L.marker([mic.lat, mic.lng], {icon, zIndexOffset: zIndex}).addTo(markersGroup);
                
                marker.on('click', () => {
                    if(!isDrawerOpen) toggleDrawer(true);
                    const card = document.getElementById(`card-${mic.id}`);
                    if(card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('flash-card');
                        setTimeout(() => card.classList.remove('flash-card'), 1000);
                    }
                });

                const card = document.createElement('div');
                card.id = `card-${mic.id}`;
                card.onclick = () => locateMic(mic.lat, mic.lng, mic.id);

                const isCardUrgent = mic.isUrgent && mic.start.toDateString() === now.toDateString();
                const statusColor = isCardUrgent ? 'rose' : 'amber';
                const spineColor = isCardUrgent ? 'bg-rose-500' : 'bg-amber-500';
                const badgeBg = isCardUrgent ? 'bg-rose-950/30 border-rose-900 text-rose-500' : 'bg-amber-950/30 border-amber-900/50 text-amber-500';
                const statusText = isCardUrgent ? 'Live' : 'Soon';

                card.className = `lens-card group relative rounded-2xl p-3 flex gap-3 cursor-pointer mb-2 overflow-hidden`;

                card.innerHTML = `
                    <!-- Left color spine -->
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${spineColor}"></div>

                    <!-- COLUMN A: TIME BLOCK -->
                    <div class="flex flex-col items-center justify-center w-[4.5rem] shrink-0 border-r border-white/5 pr-3 relative z-10">
                        <span class="text-2xl font-black text-white leading-none font-mono">${mic.timeStr}</span>
                        <div class="mt-3 flex items-center gap-1.5 px-1.5 py-0.5 ${badgeBg} border rounded badge-pulse">
                            <span class="block h-1.5 w-1.5 bg-current rounded-full"></span>
                            <span class="text-[9px] font-bold uppercase tracking-wider">${statusText}</span>
                        </div>
                    </div>

                    <!-- COLUMN B: DETAILS -->
                    <div class="flex flex-col justify-center flex-1 min-w-0 relative z-10">
                        <div class="flex items-center justify-between gap-2">
                            <h3 class="text-white font-bold truncate text-base font-display group-hover:text-${statusColor}-400 transition-colors">${mic.title}</h3>
                            <span class="shrink-0 bg-white/5 border border-white/10 text-neutral-300 px-1.5 py-0.5 rounded text-[10px] font-bold tracking-wide uppercase">
                                ${mic.price} ${mic.type}
                            </span>
                        </div>
                        <div class="text-xs text-neutral-500 truncate mt-1 flex items-center gap-1.5">
                            <span>${mic.hood}</span>
                            <span class="w-0.5 h-0.5 bg-neutral-600 rounded-full"></span>
                            <span>60m</span>
                        </div>
                    </div>

                    <!-- COLUMN C: ACTION -->
                    <div class="flex flex-col items-center justify-center shrink-0 w-8 pl-2 border-l border-white/5 py-0.5 relative z-10">
                        <button class="action-icon text-neutral-400" title="Sign Up Online">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --------------------------------------------------------
        // 4. INTERACTIONS
        // --------------------------------------------------------

        function selectDate(dateString) {
            currentMode = 'calendar';
            selectedCalendarDate = dateString;
            hideDateCarousel();

            document.querySelectorAll('.capsule-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-calendar').classList.add('active');
            
            if(!isDrawerOpen) toggleDrawer(true);
            
            updateDateCarouselHighlight(dateString);
            render('calendar');
        }
        
        function showDateCarousel() { document.getElementById('date-carousel').style.transform = 'translateY(0)'; }
        function hideDateCarousel() { document.getElementById('date-carousel').style.transform = 'translateY(100%)'; }

        function updateDateCarouselHighlight(dateString) {
            document.querySelectorAll('.date-capsule').forEach(cap => {
                cap.classList.toggle('active-date', cap.dataset.date === dateString);
            });
        }

        function setMode(mode) {
            document.querySelectorAll('.capsule-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            if (mode === 'calendar') {
                toggleDrawer(false); 
                showDateCarousel();
                currentMode = 'calendar';
            } else {
                hideDateCarousel();
                currentMode = mode;
                selectedCalendarDate = (mode === 'today') ? now.toDateString() : addDays(now, 1).toDateString();
                render(mode);
            }
        }

        function toggleDrawer(forceOpen) {
            const drawer = document.getElementById('list-drawer');
            const icon = document.getElementById('chevron-icon');
            const btn = document.getElementById('drawer-btn');
            
            isDrawerOpen = forceOpen !== undefined ? forceOpen : !isDrawerOpen;
            
            // Checking media query to know if we are on desktop
            const isDesktop = window.matchMedia('(min-width: 768px)').matches;
            
            if(isDrawerOpen) {
                if(currentMode === 'calendar') return;
                
                // Height logic split
                if (isDesktop) {
                     drawer.style.maxHeight = '90vh';
                } else {
                     drawer.style.maxHeight = '55vh'; // Mobile Bottom Sheet limit
                }
                
                drawer.style.opacity = '1';
                icon.style.transform = 'rotate(180deg)';
                btn.classList.add('bg-white/10', 'text-white');
            } else {
                drawer.style.maxHeight = '0';
                drawer.style.opacity = '0';
                icon.style.transform = 'rotate(0deg)';
                btn.classList.remove('bg-white/10', 'text-white');
            }
        }

        function locateMic(lat, lng, id) {
            map.flyTo([lat, lng], 15, { duration: 1.2, easeLinearity: 0.25 });
            const pin = document.getElementById(`pin-${id}`);
            if(pin) {
                pin.parentElement.style.zIndex = 10000; 
                pin.style.transform = 'scale(2)';
                setTimeout(() => pin.style.transform = 'scale(1)', 500);
            }
        }

        document.getElementById('search-input').addEventListener('keyup', () => {
            hideDateCarousel();
            if(!isDrawerOpen) toggleDrawer(true);
            render(currentMode);
        });

        // --------------------------------------------------------
        // 5. INITIALIZATION
        // --------------------------------------------------------
        function generateDateCarousel() {
            const container = document.getElementById('cal-grid');
            const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
            
            for(let i = 0; i < 7; i++) {
                const date = addDays(now, i);
                const dayStr = days[date.getDay()];
                const dateNum = date.getDate();
                const dateString = date.toDateString();

                const capsule = document.createElement('div');
                capsule.className = `date-capsule flex-shrink-0 w-14 h-16 rounded-xl transition-all cursor-pointer flex flex-col items-center justify-center text-center text-neutral-400 font-bold bg-black/40 hover:bg-white/10 active:scale-95
                                     ${dateString === selectedCalendarDate ? 'active-date' : ''}`;
                capsule.dataset.date = dateString;
                capsule.onclick = () => selectDate(dateString);
                capsule.innerHTML = `<span class="text-xs uppercase">${dayStr}</span><span class="text-2xl mt-0.5 leading-none text-white">${dateNum}</span>`;
                container.appendChild(capsule);
            }
            const style = document.createElement('style');
            style.innerHTML = `.date-capsule.active-date { background: #fbbf24; color: black !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); } .date-capsule.active-date span { color: black !important; }`;
            document.head.appendChild(style);
        }

        generateDateCarousel();
        render('today');
        setTimeout(() => toggleDrawer(true), 500);

    </script>
</body>
</html>