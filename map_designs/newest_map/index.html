<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>MicFinder NYC</title>
    <link rel="manifest" href="../manifest.json">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- App CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/drawer.css">
    <link rel="stylesheet" href="css/stream.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/controls.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body class="h-screen w-screen relative selection:bg-rose-500 selection:text-white">

    <!-- SKIP LINK -->
    <a href="#list-content" class="skip-link">Skip to mic listings</a>

    <!-- MAIN CONTENT -->
    <main id="main-content">

    <!-- MAP LAYER -->
    <div id="map" class="absolute inset-0 z-0 bg-[#e8e4dc]"></div>

    <!-- LOCATE ME BUTTON -->
    <button onclick="centerOnUser()" id="locate-btn" class="locate-btn" aria-label="Center map on my location" data-tooltip="Current Location">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path>
        </svg>
    </button>

    <!-- COMMAND BAR -->
    <div class="absolute top-4 left-3 right-3 md:left-4 md:right-auto md:w-[380px] z-[1000] flex flex-col pointer-events-none" role="search">
        <div class="search-wrapper pointer-events-auto relative z-20">
            <!-- Input section -->
            <div class="input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="#8E8E93" aria-hidden="true">
                    <path d="M10.5 4C6.9 4 4 6.9 4 10.5C4 14.1 6.9 17 10.5 17C12 17 13.4 16.5 14.5 15.6L18.4 19.5C18.8 19.9 19.4 19.9 19.8 19.5C20.2 19.1 20.2 18.5 19.8 18.1L15.9 14.2C16.6 13.1 17 11.9 17 10.5C17 6.9 14.1 4 10.5 4ZM6 10.5C6 8 8 6 10.5 6C13 6 15 8 15 10.5C15 13 13 15 10.5 15C8 15 6 13 6 10.5Z"/>
                </svg>
                <input type="text" id="search-input" class="search-input" placeholder="Search address..." autocomplete="off" maxlength="100" aria-label="Search venues or location">
            </div>

            <!-- Set Location (Pin Drop) Button -->
            <div class="pin-btn" id="pinBtn" onclick="togglePinDropMode()">
                <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <span class="pin-text">Set Location</span>
            </div>

            <!-- Divider -->
            <div class="divider"></div>

            <!-- Drawer Toggle Btn (UNCHANGED) -->
            <button onclick="toggleDrawer()" id="drawer-btn" class="flex w-11 h-11 rounded-full hover:bg-white/10 items-center justify-center text-neutral-400 hover:text-white transition-all active:scale-90 flex-shrink-0" aria-label="Toggle mic list" aria-expanded="true" aria-controls="list-drawer">
                <svg id="chevron-icon" class="w-5 h-5 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- MOBILE FILTER PILLS (below search bar, mobile only) -->
    <div id="mobile-filters" class="mobile-filter-bar" role="group" aria-label="Filter options">
        <button class="mobile-filter-icon" id="mobile-filter-reset" onclick="showAllMics()" aria-label="Clear all filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        </button>
        <button class="mobile-filter-pill" id="mobile-filter-price" data-filter="price" onclick="cycleFilter('price')">Price</button>
        <button class="mobile-filter-pill" id="mobile-filter-time" data-filter="time" onclick="cycleFilter('time')">Time</button>
        <button class="mobile-filter-pill" id="mobile-filter-borough" data-filter="borough" onclick="cycleFilter('borough')">Borough</button>
        <button class="mobile-filter-icon mobile-calendar-date-btn" id="mobile-calendar-btn" onclick="setMode('calendar')" aria-label="Open calendar picker">
            <div class="cal-header">
                <span id="mobile-cal-month"></span>
                <svg class="cal-chevron" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="cal-body" id="mobile-cal-date-num"></div>
        </button>
    </div>

    <!-- BACKDROP (mobile only - tap to close drawer) -->
    <div id="drawer-backdrop" onclick="setDrawerState(DRAWER_STATES.PEEK)"></div>

    <!-- LIST DRAWER -->
    <div id="list-drawer" role="region" aria-label="Mic listings" class="glass-panel overflow-hidden flex flex-col
        fixed bottom-0 left-0 right-0 z-[900] rounded-t-3xl
        md:rounded-3xl md:absolute md:top-[80px] md:left-4 md:right-auto md:w-[380px] md:bottom-auto md:z-[999]">

        <!-- HEADER -->
        <div id="drawer-header" class="shrink-0 sticky top-0 z-30 overflow-visible">
            <!-- Drag Handle (mobile only) - 48px touch target for accessibility -->
            <button onclick="toggleDrawer()" class="drag-handle absolute top-0 left-1/2 -translate-x-1/2 w-20 h-12 md:hidden cursor-grab active:cursor-grabbing z-10 flex items-center justify-center touch-none" aria-label="Drag to resize or tap to toggle mic list" aria-expanded="true" aria-controls="list-drawer">
                <span class="w-12 h-1.5 bg-white/40 rounded-full group-active:bg-white/60 transition-colors"></span>
            </button>

            <!-- Mics Header Row (New Design) -->
            <div class="mics-header-row">
                <!-- Left: Title & Count -->
                <div class="title-group">
                    <h1 class="title-text">Mics</h1>
                    <span class="count-text" id="mic-count" aria-live="polite" aria-atomic="true"></span>
                    <span class="commute-loading" id="commute-loading">Loading commute times...</span>
                </div>

                <!-- Right: Controls -->
                <div class="controls-group">
                    <!-- Minimize Button (desktop only) -->
                    <button class="minimize-btn" onclick="toggleDrawer(false)" aria-label="Minimize drawer">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>

                    <!-- Calendar Button -->
                    <button class="calendar-icon-btn calendar-date-btn" id="btn-calendar" onclick="setMode('calendar')" aria-label="Open calendar picker">
                        <div class="cal-header">
                            <span id="cal-month"></span>
                            <svg class="cal-chevron" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="cal-body" id="cal-date-num"></div>
                    </button>

                    <!-- Sync Map Toggle (mobile only) -->
                    <button class="sync-map-btn mobile-only" id="btn-sync-map" onclick="toggleSyncWithMap()" aria-label="Sync list with map view" aria-pressed="false">
                        Sync W/Map
                    </button>

                    <!-- Settings Button (gear) -->
                    <button class="more-icon-btn" id="btn-settings" onclick="settingsService.open()" aria-label="Settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Filter Row (desktop only - hidden on mobile) -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar" id="drawer-filters" role="group" aria-label="Filter options">
                <!-- Price Filter -->
                <button class="drawer-filter-btn" id="filter-price" onclick="event.stopPropagation(); cycleFilter('price')" aria-label="Filter by price">
                    Price
                </button>

                <!-- Time Filter -->
                <button class="drawer-filter-btn" id="filter-time" onclick="event.stopPropagation(); toggleTimePopover()" aria-label="Filter by time" aria-expanded="false" aria-controls="time-popover">
                    Time
                    <svg class="filter-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>

                <!-- Borough Filter -->
                <button class="drawer-filter-btn" id="filter-borough" onclick="event.stopPropagation(); toggleBoroughPopover()" aria-label="Filter by borough" aria-expanded="false" aria-controls="borough-popover">
                    Borough
                    <svg class="filter-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>

                <!-- Commute Filter (only visible in transit mode) -->
                <button class="drawer-filter-btn" id="filter-commute" onclick="event.stopPropagation(); cycleFilter('commute')" style="display: none;" aria-label="Filter by commute time">
                    Commute
                </button>

            </div>
        </div>

        <!-- MTA ALERTS BANNER -->
        <div id="mta-alerts" class="mta-alerts-container" role="alert" aria-live="assertive" style="display: none;"></div>

        <!-- CONTENT LIST -->
        <div id="list-content" class="overflow-y-auto no-scrollbar scroll-smooth bg-transparent" role="feed" aria-label="Upcoming mics" tabindex="0">
            <!-- CARDS INJECTED HERE -->
        </div>
    </div>

    <!-- DATE CAROUSEL -->
    <div id="date-carousel" class="fixed bottom-0 left-0 right-0 z-[1100] p-4 pointer-events-none transform translate-y-full transition-transform duration-300">
        <div class="glass-panel mx-auto rounded-xl py-3 px-3 w-full md:max-w-xl pointer-events-auto">
            <div id="cal-grid" class="flex justify-start overflow-x-auto gap-2 no-scrollbar">
                <!-- Date Capsules Injected Here -->
            </div>
        </div>
    </div>

    </main>

    <!-- VENUE MODAL -->
    <div class="modal-overlay" id="venue-modal" role="dialog" aria-modal="true" aria-labelledby="modal-venue-name">
        <div class="venue-card">
            <!-- 0. TABS (shown when multiple mics at same location) -->
            <div class="modal-tabs" id="modal-tabs"></div>

            <!-- 1. HEADER SECTION -->
            <div class="header-section">
                <div class="header-top">
                    <h2 id="modal-venue-name">The Gray Mare</h2>
                    <span class="time-display" id="modal-mic-time">7:00 PM</span>
                </div>

                <div class="sub-header">
                    <span class="address" id="modal-address">61 2nd Ave</span>
                    <a href="#" class="maps-link" id="modal-directions">Maps ↗</a>
                </div>

                <p class="note-text" id="modal-instructions">Sign up in person</p>

                <div class="action-row" id="modal-actions">
                    <a href="#" class="btn btn-primary" id="modal-signup-btn">Sign Up Link</a>
                    <a href="#" class="btn btn-ig" id="modal-ig-btn">IG</a>
                </div>
            </div>

            <!-- 2. CONTENT SHEET (Transit Cards) -->
            <div class="content-sheet" id="modal-transit">
                <!-- Transit cards injected dynamically -->
            </div>
        </div>
    </div>

    <!-- More Menu Popover -->
    <div class="more-popover" id="more-popover" role="menu" aria-label="More options">
        <button class="more-option" onclick="settingsService.open(); toggleMoreMenu()" role="menuitem">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>Settings</span>
        </button>
    </div>

    <!-- Borough Filter Popover -->
    <div class="filter-popover" id="borough-popover" role="listbox" aria-label="Filter by borough">
        <button class="popover-option active" data-value="All" onclick="selectBoroughFilter('All')" role="option" aria-selected="true">
            <span class="option-label">All Boroughs</span>
        </button>
        <button class="popover-option" data-value="Manhattan" onclick="selectBoroughFilter('Manhattan')" role="option" aria-selected="false">
            <span class="option-label">Manhattan</span>
        </button>
        <button class="popover-option" data-value="Brooklyn" onclick="selectBoroughFilter('Brooklyn')" role="option" aria-selected="false">
            <span class="option-label">Brooklyn</span>
        </button>
        <button class="popover-option" data-value="Queens" onclick="selectBoroughFilter('Queens')" role="option" aria-selected="false">
            <span class="option-label">Queens</span>
        </button>
        <button class="popover-option" data-value="Bronx" onclick="selectBoroughFilter('Bronx')" role="option" aria-selected="false">
            <span class="option-label">Bronx</span>
        </button>
    </div>

    <!-- Time Filter Popover (outside drawer for z-index) -->
    <div class="filter-popover" id="time-popover" role="listbox" aria-label="Filter by time of day">
        <button class="popover-option active" data-value="All" onclick="selectTimeFilter('All')" role="option" aria-selected="true">
            <span class="option-label">All Times</span>
        </button>
        <button class="popover-option" data-value="afternoon" onclick="selectTimeFilter('afternoon')" role="option" aria-selected="false">
            <span class="option-label">Afternoon</span>
            <span class="option-detail">12pm – 5pm</span>
        </button>
        <button class="popover-option" data-value="evening" onclick="selectTimeFilter('evening')" role="option" aria-selected="false">
            <span class="option-label">Evening</span>
            <span class="option-detail">5pm – 9pm</span>
        </button>
        <button class="popover-option" data-value="latenight" onclick="selectTimeFilter('latenight')" role="option" aria-selected="false">
            <span class="option-label">Late Night</span>
            <span class="option-detail">After 9pm</span>
        </button>
        <div class="popover-divider"></div>
        <button class="popover-option" data-value="custom" onclick="showCustomTimeInputs()" role="option" aria-selected="false">
            <span class="option-label">Custom</span>
            <svg class="custom-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <div class="custom-time-inputs" id="custom-time-inputs" style="display: none;">
            <div class="time-input-row">
                <label>From</label>
                <input type="time" id="custom-time-start" value="17:00">
            </div>
            <div class="time-input-row">
                <label>To</label>
                <input type="time" id="custom-time-end" value="21:00">
            </div>
            <button class="custom-time-apply" onclick="applyCustomTime()">Apply</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="alert-modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="alert-title" onclick="this.classList.remove('show')">
        <div class="alert-modal" onclick="event.stopPropagation()">
            <div class="alert-modal-header">
                <div class="alert-modal-badge b-1" id="alert-badge">1</div>
                <span class="alert-modal-title" id="alert-title">Delays</span>
            </div>
            <div class="alert-modal-text" id="alert-text">
                Service alert details here.
            </div>
            <button class="alert-modal-close" onclick="document.getElementById('alertModal').classList.remove('show')" aria-label="Dismiss alert">
                Dismiss
            </button>
        </div>
    </div>

    <!-- App JS (order matters!) -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/map.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/drawer.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/nyc-geocoder.js"></script>
    <script src="js/search.js"></script>
    <script src="js/transit.js"></script>
    <script src="js/mta.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/render.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
