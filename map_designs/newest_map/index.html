<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>MicFinder NYC</title>
    <link rel="manifest" href="manifest.json">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- App CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/drawer.css">
    <link rel="stylesheet" href="css/stream.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/controls.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body class="h-screen w-screen relative selection:bg-rose-500 selection:text-white">

    <!-- SKIP LINK -->
    <a href="#list-content" class="skip-link">Skip to mic listings</a>

    <!-- MAIN CONTENT -->
    <main id="main-content">

    <!-- MAP LAYER -->
    <div id="map" class="absolute inset-0 z-0 bg-[#e8e4dc]"></div>

    <!-- MAP LEGEND -->
    <div class="map-legend" id="map-legend">
        <div class="legend-item"><div class="legend-dot live"></div>Live</div>
        <div class="legend-item"><div class="legend-dot soon"></div>Soon</div>
        <div class="legend-item later"><div class="legend-dot later"></div>Later</div>
    </div>

    <!-- LOCATE ME BUTTON -->
    <button onclick="centerOnUser()" id="locate-btn" class="locate-btn" aria-label="Center map on my location">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path>
        </svg>
    </button>

    <!-- COMMAND BAR -->
    <div class="absolute top-4 left-3 right-3 md:left-auto md:right-4 md:w-[400px] z-[1000] flex flex-col pointer-events-none" role="search">
        <div class="search-wrapper pointer-events-auto relative z-20">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" class="search-input" placeholder="Search mics or enter your location..." autocomplete="off" maxlength="100" aria-label="Search venues or location">
            <!-- Clear button -->
            <button id="search-clear-btn" class="search-clear-btn" onclick="searchService.clear()" aria-label="Clear search">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <!-- Divider -->
            <div class="search-divider"></div>
            <!-- Quick Location Button -->
            <button id="search-location-btn" class="search-location-btn" onclick="searchService.useMyLocation()" aria-label="Use my location">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                </svg>
            </button>
            <!-- Divider (hidden on mobile) -->
            <div class="w-[1px] h-5 bg-white/10 mx-1 hidden md:block flex-shrink-0"></div>
            <!-- Drawer Btn (hidden on mobile - use drag handle instead) -->
            <button onclick="toggleDrawer()" id="drawer-btn" class="hidden md:flex w-11 h-11 rounded-full hover:bg-white/10 items-center justify-center text-neutral-400 hover:text-white transition-all active:scale-90 flex-shrink-0" aria-label="Toggle mic list" aria-expanded="true" aria-controls="list-drawer">
                <svg id="chevron-icon" class="w-5 h-5 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- LIST DRAWER -->
    <div id="list-drawer" role="region" aria-label="Mic listings" class="glass-panel rounded-3xl overflow-hidden flex flex-col
        fixed bottom-4 left-3 right-3 z-[900]
        md:absolute md:top-[80px] md:left-auto md:right-4 md:w-[400px] md:bottom-auto md:z-[999]">

        <!-- HEADER -->
        <div id="drawer-header" class="shrink-0 sticky top-0 z-30 overflow-visible">
            <!-- Drag Handle (mobile only) - 48px touch target for accessibility -->
            <button onclick="toggleDrawer()" class="drag-handle absolute top-0 left-1/2 -translate-x-1/2 w-20 h-12 md:hidden cursor-grab active:cursor-grabbing z-10 flex items-center justify-center touch-none" aria-label="Drag to resize or tap to toggle mic list" aria-expanded="true" aria-controls="list-drawer">
                <span class="w-12 h-1.5 bg-white/40 rounded-full group-active:bg-white/60 transition-colors"></span>
            </button>

            <!-- Mics Header Row (New Design) -->
            <div class="mics-header-row">
                <!-- Left: Title & Count -->
                <div class="title-group">
                    <h1 class="title-text">Mics</h1>
                    <span class="count-text" id="mic-count" aria-live="polite" aria-atomic="true">0</span>
                </div>

                <!-- Right: Controls -->
                <div class="controls-group">
                    <!-- Calendar Button -->
                    <button class="calendar-icon-btn" id="btn-calendar" onclick="setMode('calendar')" aria-label="Open calendar picker">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </button>

                    <!-- Settings Button -->
                    <button class="settings-icon-btn" id="btn-settings" onclick="settingsService.open()" aria-label="Open settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Filter Row -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar px-4 py-2 bg-[#0f0f0f]" id="drawer-filters" role="group" aria-label="Filter options">
                <!-- Home Button -->
                <button class="drawer-filter-btn active" id="btn-home" onclick="event.stopPropagation(); showAllMics()" aria-label="Show all mics">
                    Home
                </button>

                <!-- Price Filter -->
                <button class="drawer-filter-btn" id="filter-price" onclick="event.stopPropagation(); cycleFilter('price')" aria-label="Filter by price">
                    Price
                </button>

                <!-- Time Filter -->
                <button class="drawer-filter-btn" id="filter-time" onclick="event.stopPropagation(); toggleTimePopover()" aria-label="Filter by time" aria-expanded="false" aria-controls="time-popover">
                    Time
                    <svg class="filter-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>

                <!-- Commute Filter (only visible in transit mode) -->
                <button class="drawer-filter-btn" id="filter-commute" onclick="event.stopPropagation(); cycleFilter('commute')" style="display: none;" aria-label="Filter by commute time">
                    Commute
                </button>

            </div>
        </div>

        <!-- MTA ALERTS BANNER -->
        <div id="mta-alerts" class="mta-alerts-container" role="alert" aria-live="assertive" style="display: none;"></div>

        <!-- CONTENT LIST -->
        <div id="list-content" class="overflow-y-auto no-scrollbar scroll-smooth bg-transparent" role="feed" aria-label="Upcoming mics" tabindex="0">
            <!-- CARDS INJECTED HERE -->
        </div>
    </div>

    <!-- DATE CAROUSEL -->
    <div id="date-carousel" class="fixed bottom-0 left-0 right-0 z-[1100] p-4 pointer-events-none transform translate-y-full transition-transform duration-300">
        <div class="glass-panel mx-auto rounded-xl py-3 px-3 w-full md:max-w-xl pointer-events-auto">
            <div id="cal-grid" class="flex justify-start overflow-x-auto gap-2 no-scrollbar">
                <!-- Date Capsules Injected Here -->
            </div>
        </div>
    </div>

    </main>

    <!-- VENUE MODAL -->
    <div class="modal-overlay" id="venue-modal" role="dialog" aria-modal="true" aria-labelledby="modal-venue-name">
        <div class="venue-card">
            <!-- 1. HEADER SECTION -->
            <div class="header-section">
                <div class="header-top">
                    <h2 id="modal-venue-name">The Gray Mare</h2>
                    <span class="time-display" id="modal-mic-time">7:00 PM</span>
                </div>

                <div class="sub-header">
                    <span class="address" id="modal-address">61 2nd Ave</span>
                    <a href="#" class="maps-link" id="modal-directions">Maps ↗</a>
                </div>

                <p class="note-text" id="modal-instructions">Sign up in person</p>

                <div class="action-row" id="modal-actions">
                    <a href="#" class="btn btn-primary" id="modal-signup-btn">Sign Up Link</a>
                    <a href="#" class="btn btn-ig" id="modal-ig-btn">IG</a>
                </div>
            </div>

            <!-- 2. CONTENT SHEET (Transit Cards) -->
            <div class="content-sheet" id="modal-transit">
                <!-- Transit cards injected dynamically -->
            </div>
        </div>
    </div>

    <!-- Time Filter Popover (outside drawer for z-index) -->
    <div class="filter-popover" id="time-popover" role="listbox" aria-label="Filter by time of day">
        <button class="popover-option active" data-value="All" onclick="selectTimeFilter('All')" role="option" aria-selected="true">
            <span class="option-label">All Times</span>
        </button>
        <button class="popover-option" data-value="morning" onclick="selectTimeFilter('morning')" role="option" aria-selected="false">
            <span class="option-label">Morning</span>
            <span class="option-detail">Before 12pm</span>
        </button>
        <button class="popover-option" data-value="afternoon" onclick="selectTimeFilter('afternoon')" role="option" aria-selected="false">
            <span class="option-label">Afternoon</span>
            <span class="option-detail">12pm – 5pm</span>
        </button>
        <button class="popover-option" data-value="evening" onclick="selectTimeFilter('evening')" role="option" aria-selected="false">
            <span class="option-label">Evening</span>
            <span class="option-detail">5pm – 9pm</span>
        </button>
        <button class="popover-option" data-value="latenight" onclick="selectTimeFilter('latenight')" role="option" aria-selected="false">
            <span class="option-label">Late Night</span>
            <span class="option-detail">After 9pm</span>
        </button>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="alert-modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="alert-title" onclick="this.classList.remove('show')">
        <div class="alert-modal" onclick="event.stopPropagation()">
            <div class="alert-modal-header">
                <div class="alert-modal-badge b-1" id="alert-badge">1</div>
                <span class="alert-modal-title" id="alert-title">Delays</span>
            </div>
            <div class="alert-modal-text" id="alert-text">
                Service alert details here.
            </div>
            <button class="alert-modal-close" onclick="document.getElementById('alertModal').classList.remove('show')" aria-label="Dismiss alert">
                Dismiss
            </button>
        </div>
    </div>

    <!-- App JS (order matters!) -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/map.js"></script>
    <script src="js/modal.js"></script>
    <script src="js/drawer.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/search.js"></script>
    <script src="js/transit.js"></script>
    <script src="js/mta.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/render.js"></script>
    <script src="js/app.js"></script>

</body>
</html>
